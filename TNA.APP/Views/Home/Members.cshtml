@using TNA.APP.Models
@model List<MemberViewModel>

@section Hero { }

@{
    ViewData["Title"] = "Miembros";
    string IconClassFor(string id) => id?.ToUpperInvariant() switch
    {
        "IG" => "bi-instagram",
        "YT" => "bi-youtube",
        "DC" or "DI" => "bi-discord",
        "TW" => "bi-twitch",
        "FB" => "bi-facebook",
        "X" => "bi-x",
        "ST" => "bi-steam",
        _ => "bi-link-45deg"
    };
}
<section class="container mt-5">
    <h2 class="mb-3">Miembros del clan</h2>

    @if (Model == null || !Model.Any())
    {
        <div class="glass-card">No hay miembros para mostrar.</div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var item in Model)
            {
                var m = item.Member;
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <article class="glass-card d-flex flex-column align-items-start">
                        <div class="w-100 d-flex align-items-center gap-3">
                            <img src="@(Url.Content(string.IsNullOrWhiteSpace(m.ProfileImage) ? "~/images/avatar-placeholder.webp" : m.ProfileImage))"
                                 alt="@m.Nickname"
                                 class="rounded-circle member-avatar" />
                            <div class="flex-grow-1">
                                <div class="d-flex">
                                    <div class="card-title">@m.Nickname</div>
                                    <div>
                                        @* botón ahora tiene data-playerid y data-playernick y clase para binding *@
                                        <a class="stats-link btn-lifetime-stats" href="#" data-playerid="@m.PlayerId" data-playernick="@m.Nickname" title="Ver estadísticas lifetime">
                                            <i class="bi bi-bar-chart-fill"></i>
                                        </a>
                                    </div>
                                </div>

                                <div class="glass-meta small">
                                    @if (!string.IsNullOrWhiteSpace(m.FirstName) || !string.IsNullOrWhiteSpace(m.LastName))
                                    {
                                        @($"{m.FirstName} {m.LastName}".Trim())
                                    }
                                    else
                                    {
                                        <span class="text-muted">Sin nombre</span>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 w-100">
                            @if (!string.IsNullOrWhiteSpace(m.Email))
                            {
                                <div class="small text-muted mb-2"><i class="bi bi-envelope me-1"></i> @m.Email</div>
                            }

                            <div class="d-flex flex-wrap gap-2">
                                @if (item.SocialMedias != null && item.SocialMedias.Any())
                                {
                                    foreach (var sm in item.SocialMedias.Where(s => s.Enabled))
                                    {
                                        var icon = IconClassFor(sm.SocialMediaId);
                                        <a class="social-link" href="@sm.SocialMediaUrl" target="_blank" rel="noopener noreferrer" aria-label="@sm.SocialMediaId">
                                            <i class="@icon"></i>
                                        </a>
                                    }
                                }
                                else
                                {
                                    <span class="badge-accent">Sin redes</span>
                                }
                            </div>
                        </div>
                    </article>
                </div>
            }
        </div>
    }
</section>

@* Modal para mostrar lifetime stats *@
<div class="modal fade" id="lifetimeModal" tabindex="-1" aria-labelledby="lifetimeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="lifetimeModalLabel">Lifetime stats</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="lifetimeContent" style="display:none;">
                    <div class="mb-3">
                        <strong>Jugador:</strong> <span id="lifetimePlayerName"></span>
                    </div>

                    <div id="modesContainer" class="row g-3">
                        <!-- Secciones por modo dinámicas -->
                    </div>
                </div>

                <div id="lifetimeError" class="alert alert-danger d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function ($) {
            $(function () {
                var modalEl = document.getElementById('lifetimeModal');
                var bsModal = new bootstrap.Modal(modalEl, {});

                function formatDuration(value) {
                    if (value == null || value === '') return '00:00:00';
                    var secs = Number(value);
                    if (isNaN(secs) || !isFinite(secs)) return String(value);
                    var total = Math.floor(secs);
                    var h = Math.floor(total / 3600);
                    var m = Math.floor((total % 3600) / 60);
                    var s = total % 60;
                    return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
                }

                function renderModeCard(modeKey, data) {
                    if (!data) {
                        return '<div class="col-12"><div class="glass-card p-3">No hay datos para ' + modeKey + '.</div></div>';
                    }

                    var wins = data.wins ?? 0;
                    var kills = data.kills ?? 0;
                    var damage = data.damageDealt ?? 0;
                    var rounds = data.roundsPlayed ?? 0;
                    var timeSurvived = formatDuration(data.timeSurvived ?? 0);
                    var headshots = data.headshotKills ?? 0;
                    var assists = data.assists ?? 0;
                    var revives = data.revives ?? 0;
                    var top10s = data.top10s ?? 0;

                    var html =
                        '<div class="col-12 col-md-6">' +
                        '<div class="glass-card p-3">' +
                        '<h6 class="mb-2 text-capitalize">' + modeKey.replace('-', ' ') + '</h6>' +
                        '<div class="row">' +
                        '<div class="col-6"><strong>Victorias:</strong> ' + wins + '</div>' +
                        '<div class="col-6"><strong>Muertes:</strong> ' + kills + '</div>' +
                        '<div class="col-6"><strong>Headshots:</strong> ' + headshots + '</div>' +
                        '<div class="col-6"><strong>Asistencias:</strong> ' + assists + '</div>' +
                        '<div class="col-6"><strong>Revives:</strong> ' + revives + '</div>' +
                        '<div class="col-6"><strong>Top10s:</strong> ' + top10s + '</div>' +
                        '<div class="col-6"><strong>Rondas:</strong> ' + rounds + '</div>' +
                        '<div class="col-6"><strong>Daño:</strong> ' + damage + '</div>' +
                        '<div class="col-12"><strong>Tiempo de juego:</strong> ' + timeSurvived + '</div>' +
                        '</div></div></div>';
                    return html;
                }

                $('.btn-lifetime-stats').on('click', function (e) {
                    e.preventDefault();
                    var $btn = $(this);
                    var playerId = $btn.data('playerid');
                    var playerNick = $btn.data('playernick') || playerId;

                    if (!playerId) return;

                    $('#lifetimeModalLabel').text('Lifetime stats — ' + playerNick);
                    $('#lifetimePlayerName').text(playerNick);
                    $('#lifetimeError').addClass('d-none').text('');
                    $('#lifetimeContent').hide();
                    $('#modesContainer').empty();

                    // Mostrar spinner y marcar aria-busy
                    $('#lifetimeSpinner').show().attr('aria-busy', 'true');

                    bsModal.show();

                    $.ajax({
                        url: '@Url.Action("PlayerLifetimeStats", "Home")',
                        method: 'GET',
                        data: { playerId: playerId },
                        dataType: 'json',
                        timeout: 15000, // 15s timeout razonable
                        success: function (resp) {
                            console.debug('PlayerLifetimeStats: respuesta recibida', resp);
                            try {
                                var gm = resp && resp.data && resp.data.attributes && resp.data.attributes.gameModeStats ? resp.data.attributes.gameModeStats : null;
                                if (!gm) {
                                    $('#lifetimeError').removeClass('d-none').text('No se encontraron estadísticas para este jugador.');
                                    return;
                                }

                                var modes = ['solo', 'duo', 'squad', 'solo-fpp', 'duo-fpp', 'squad-fpp'];
                                var html = '';
                                modes.forEach(function (m) {
                                    var entry = gm[m];
                                    html += renderModeCard(m, entry);
                                });

                                $('#modesContainer').html(html);
                                $('#lifetimeContent').show();
                            } catch (ex) {
                                console.error('Error procesando la respuesta:', ex);
                                $('#lifetimeError').removeClass('d-none').text('Error procesando la respuesta.');
                            }
                        },
                        error: function (xhr, status, err) {
                            console.error('PlayerLifetimeStats: error', status, err, xhr && xhr.responseText);
                            var msg = 'Error al obtener datos.';
                            if (status === 'timeout') msg = 'La petición ha tardado demasiado. Inténtalo de nuevo.';
                            if (xhr && xhr.responseText) {
                                try { msg = JSON.parse(xhr.responseText).message || xhr.responseText; } catch (e) { /* mantener msg */ }
                            }
                            $('#lifetimeError').removeClass('d-none').text(msg);
                        },
                        complete: function () {
                            // Siempre ocultar el spinner (success o error o timeout)
                            $('#lifetimeSpinner').hide().attr('aria-busy', 'false');
                        }
                    });
                });
            });
        })(jQuery);
    </script>
}